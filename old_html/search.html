{% extends "base.html" %}
{% block title %}Search{% endblock %}
{% block content %}
<div class="container">
    <div class="card">
        <h2>Search PubMed</h2>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'warning' if category == 'warning' else 'success' }} mt-3">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% if error %}
            <div class="alert alert-danger mt-3">{{ error }}</div>
        {% endif %}
        <form id="search-form" method="POST">
            <div class="mb-3">
                <label for="query" class="form-label">Search Query</label>
                <input type="text" class="form-control" id="query" name="query" placeholder="Enter search query" value="{{ query or '' }}">
            </div>
            <div class="mb-3">
                <label for="prompt_id" class="form-label">Select Prompt</label>
                <select class="form-control" id="prompt_id" name="prompt_id" onchange="updatePromptText()">
                    <option value="">Select a prompt</option>
                    {% for prompt in prompts %}
                        <option value="{{ prompt.id }}" {% if prompt_id == prompt.id|string %}selected{% endif %}>{{ prompt.prompt_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="prompt_text" class="form-label">Custom Prompt (Optional)</label>
                <textarea class="form-control" id="prompt_text" name="prompt_text" rows="5" placeholder="Enter custom prompt">{{ prompt_text or '' }}</textarea>
            </div>
            <button type="submit" class="btn btn-primary">Search</button>
            <span id="search-spinner" class="spinner"></span>
            <span id="search-status" class="search-status"></span>
        </form>
    </div>
    {% if prompt_output %}
        <div class="card mt-3">
            <h3>Prompt Output</h3>
            <p>{{ prompt_output | replace('\n', '<br>') | safe }}</p>
        </div>
    {% endif %}
    {% if results %}
        <div class="card mt-3">
            <h3>Search Results for "{{ query }}"</h3>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Authors</th>
                            <th>Journal</th>
                            <th>Date</th>
                            <th>Summary</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result, summary in result_summaries %}
                            <tr>
                                <td>{{ result.title }}</td>
                                <td>{{ result.authors }}</td>
                                <td>{{ result.journal }}</td>
                                <td>{{ result.publication_date }}</td>
                                <td>{{ summary.text|truncate(200) }}...</td>
                                <td><a href="https://pubmed.ncbi.nlm.nih.gov/{{ result.id }}/" target="_blank">PubMed</a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}
</div>
<script>
    // Populate prompt text when a prompt is selected
    function updatePromptText() {
        const promptId = document.getElementById('prompt_id').value;
        const promptTextArea = document.getElementById('prompt_text');
        const prompts = {{ prompts | tojson }};
        const selectedPrompt = prompts.find(p => p.id == promptId);
        promptTextArea.value = selectedPrompt ? selectedPrompt.prompt_text : '';
    }

    // Handle search progress
    document.getElementById('search-form').addEventListener('submit', function() {
        const query = document.querySelector('input[name="query"]').value;
        const spinner = document.getElementById('search-spinner');
        const status = document.getElementById('search-status');
        spinner.style.display = 'inline-block';
        status.textContent = 'Starting search...';
        
        const eventSource = new EventSource(`/search_progress?query=${encodeURIComponent(query)}`);
        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                status.textContent = data.status;
                if (data.status === 'complete' || data.status.startsWith('error')) {
                    spinner.style.display = 'none';
                    eventSource.close();
                }
            } catch (e) {
                status.textContent = 'Error processing progress';
                spinner.style.display = 'none';
                eventSource.close();
            }
        };
        eventSource.onerror = function() {
            status.textContent = 'Progress update interrupted';
            spinner.style.display = 'none';
            eventSource.close();
        };
    });

    // Initialize prompt text if a prompt is pre-selected
    window.onload = function() {
        updatePromptText();
    };
</script>
<style>
    .spinner {
        display: none;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #00689B;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin-left: 10px;
        vertical-align: middle;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .search-status {
        margin-left: 10px;
        color: #00689B;
        vertical-align: middle;
    }
</style>
{% endblock %}