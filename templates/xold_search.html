{% extends "base.html" %}
{% block title %}Search{% endblock %}
{% block content %}
<div class="container">
    <h1>Fireside AI Search Assistant</h1>
    <form method="POST">
        <div class="mb-3">
            <label class="form-label">Search Sources</label>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="source_pubmed" name="sources" value="pubmed" checked>
                <label class="form-check-label" for="source_pubmed">PubMed</label>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="source_fda" name="sources" value="fda">
                <label class="form-check-label" for="source_fda">FDA.gov</label>
            </div>
        </div>
        <div class="mb-3">
            <label for="query" class="form-label">Search Query</label>
            <input type="text" class="form-control" id="query" name="query" value="{{ query|default('') }}" placeholder="e.g., weight loss and diabetes">
        </div>
        <div class="mb-3">
            <label for="prompt_id" class="form-label">Select Prompt</label>
            <select class="form-select" id="prompt_id" name="prompt_id">
                <option value="">Select a prompt...</option>
                {% for prompt in prompts %}
                    <option value="{{ prompt.id }}" {% if prompt.id == prompt_id %}selected{% endif %}>{{ prompt.prompt_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="prompt_text" class="form-label">Prompt Text</label>
            <textarea class="form-control" id="prompt_text" name="prompt_text" rows="4">{{ prompt_text|default('') }}</textarea>
        </div>
        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="search_older" name="search_older" {% if search_older %}checked{% endif %}>
            <label class="form-check-label" for="search_older">Search older articles (select start year)</label>
        </div>
        <div class="mb-3" id="start_year_div" style="display: {% if search_older %}block{% else %}none{% endif %};">
            <label for="start_year" class="form-label">Start Year</label>
            <select class="form-select" id="start_year" name="start_year">
                {% for year in range(2000, 2026) %}
                    <option value="{{ year }}" {% if year == start_year|int(default=2000) %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Search</button>
    </form>

    {% if error %}
        <div class="alert alert-danger mt-3">{{ error }}</div>
    {% endif %}

    {% if has_prompt %}
        <div class="card mt-3">
            <h3>AI Summary</h3>
            <div id="summary-loading" class="spinner"></div>
            <div id="summary-message" class="summary-generating">Generating AI response, this may take 30 to 40 seconds</div>
            <div id="summary-content"></div>
        </div>
    {% endif %}

    <div class="results-section mt-3">
        {% if total_results > 0 %}
            <div class="alert alert-info">
                Found {{ total_results }} results
            </div>
        {% endif %}
        <ul class="nav nav-tabs" id="resultsTabs" role="tablist">
            {% if pubmed_results or pubmed_ranked_results or pubmed_fallback_results %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pubmed-tab" data-bs-toggle="tab" data-bs-target="#pubmed" type="button" role="tab">PubMed</button>
                </li>
            {% endif %}
            {% if fda_results %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="fda-tab" data-bs-toggle="tab" data-bs-target="#fda" type="button" role="tab">FDA.gov</button>
                </li>
            {% endif %}
        </ul>
        <div class="tab-content" id="resultsTabsContent">
            {% if pubmed_results or pubmed_ranked_results or pubmed_fallback_results %}
                <div class="tab-pane fade show active" id="pubmed" role="tabpanel">
                    {% if pubmed_ranked_results %}
                        <div class="card mt-3">
                            <h3>Top Relevant Results (AI-Ranked)</h3>
                            {% for result in pubmed_ranked_results %}
                                <div class="card mb-2">
                                    <h5><a href="https://pubmed.ncbi.nlm.nih.gov/{{ result.id }}" target="_blank">{{ result.title }}</a></h5>
                                    <p><strong>Authors:</strong> {{ result.authors|default('N/A') }}</p>
                                    <p><strong>Journal:</strong> {{ result.journal|default('N/A') }}</p>
                                    <p><strong>Date:</strong> {{ result.publication_date|default('N/A') }}</p>
                                    <p><strong>Abstract:</strong> {{ result.abstract|default('No abstract available')|truncate(300) }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if pubmed_results %}
                        <div class="card mt-3">
                            <h3>All Results</h3>
                            {% for result in pubmed_results %}
                                <div class="card mb-2">
                                    <h5><a href="https://pubmed.ncbi.nlm.nih.gov/{{ result.id }}" target="_blank">{{ result.title }}</a></h5>
                                    <p><strong>Authors:</strong> {{ result.authors|default('N/A') }}</p>
                                    <p><strong>Journal:</strong> {{ result.journal|default('N/A') }}</p>
                                    <p><strong>Date:</strong> {{ result.publication_date|default('N/A') }}</p>
                                    <p><strong>Abstract:</strong> {{ result.abstract|default('No abstract available')|truncate(300) }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if pubmed_fallback_results %}
                        <div class="card mt-3">
                            <h3>Fallback Results (Outside Specified Timeframe)</h3>
                            {% for result in pubmed_fallback_results %}
                                <div class="card mb-2">
                                    <h5><a href="https://pubmed.ncbi.nlm.nih.gov/{{ result.id }}" target="_blank">{{ result.title }}</a></h5>
                                    <p><strong>Authors:</strong> {{ result.authors|default('N/A') }}</p>
                                    <p><strong>Journal:</strong> {{ result.journal|default('N/A') }}</p>
                                    <p><strong>Date:</strong> {{ result.publication_date|default('N/A') }}</p>
                                    <p><strong>Abstract:</strong> {{ result.abstract|default('No abstract available')|truncate(300) }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            {% endif %}
            {% if fda_results %}
                <div class="tab-pane fade" id="fda" role="tabpanel">
                    <div class="card mt-3">
                        <h3>FDA.gov Results</h3>
                        {% for result in fda_results %}
                            <div class="card mb-2">
                                <h5><a href="{{ result.url }}" target="_blank">{{ result.title }}</a></h5>
                                <p><strong>Summary:</strong> {{ result.summary|default('No summary available')|truncate(300) }}</p>
                                <p><strong>Date:</strong> {{ result.date|default('N/A') }}</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
        {% if total_results > per_page %}
            <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination justify-content-center">
                    {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('search', page=page-1, query=query, prompt_id=prompt_id, prompt_text=prompt_text, search_older=search_older, start_year=start_year) }}">Previous</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                    {% endif %}
                    {% for p in range(1, total_pages + 1) %}
                        <li class="page-item {% if p == page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('search', page=p, query=query, prompt_id=prompt_id, prompt_text=prompt_text, search_older=search_older, start_year=start_year) }}">{{ p }}</a>
                        </li>
                    {% endfor %}
                    {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('search', page=page+1, query=query, prompt_id=prompt_id, prompt_text=prompt_text, search_older=search_older, start_year=start_year) }}">Next</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Define prompts from server-side data
        const prompts = {{ prompts|tojson }};
        
        // Handle prompt selection
        const promptSelect = document.getElementById('prompt_id');
        const promptTextArea = document.getElementById('prompt_text');
        promptSelect.addEventListener('change', function() {
            const selectedPromptId = this.value;
            const selectedPrompt = prompts.find(p => p.id === selectedPromptId);
            if (selectedPrompt) {
                promptTextArea.value = selectedPrompt.prompt_text;
            } else {
                promptTextArea.value = '';
            }
        });

        // Handle search older checkbox
        const searchOlderCheckbox = document.getElementById('search_older');
        const startYearDiv = document.getElementById('start_year_div');
        searchOlderCheckbox.addEventListener('change', function() {
            startYearDiv.style.display = this.checked ? 'block' : 'none';
        });

        // Fetch summary if prompt exists
        if ({{ has_prompt|tojson }}) {
            fetchSummary();
        }
    });

    function fetchSummary() {
        const query = '{{ query|default('')|e }}';
        const promptText = document.getElementById('prompt_text').value;
        const pubmedResults = {{ pubmed_results|tojson }};
        const pubmedFallbackResults = {{ pubmed_fallback_results|tojson }};
        const promptParams = {{ prompt_params|tojson }};

        const formData = new FormData();
        formData.append('query', query);
        formData.append('prompt_text', promptText);
        formData.append('results', JSON.stringify(pubmedResults));
        formData.append('fallback_results', JSON.stringify(pubmedFallbackResults));
        formData.append('prompt_params', JSON.stringify(promptParams));

        document.getElementById('summary-loading').style.display = 'inline-block';
        document.getElementById('summary-message').style.display = 'block';

        fetch('{{ url_for('search_summary') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('summary-loading').style.display = 'none';
            document.getElementById('summary-message').style.display = 'none';
            const summaryContent = document.getElementById('summary-content');
            if (data.status === 'success') {
                summaryContent.innerHTML = data.prompt_output;
                if (data.fallback_prompt_output) {
                    summaryContent.innerHTML += '<h4>Fallback Summary</h4>' + data.fallback_prompt_output;
                }
            } else {
                summaryContent.innerHTML = '<p class="error-message">Error generating summary: ' + data.message + '</p>';
            }
        })
        .catch(error => {
            document.getElementById('summary-loading').style.display = 'none';
            document.getElementById('summary-message').style.display = 'none';
            document.getElementById('summary-content').innerHTML = '<p class="error-message">Failed to load summary: ' + error + '</p>';
        });
    }
</script>
{% endblock %}