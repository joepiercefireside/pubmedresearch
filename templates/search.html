<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PubMed Researcher - Search</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00689B;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #search-status {
            margin-left: 10px;
            color: #00689B;
        }
    </style>
</head>
<body>
    <nav style="background-color: #00689B; padding: 10px;">
        <a href="{{ url_for('index') }}" style="color: white; text-decoration: none;">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" style="height: 30px; vertical-align: middle;">
            PubMed Research
        </a>
        <div style="float: right; color: white;">
            Hello, {{ username }} | 
            <a href="{{ url_for('prompt') }}" style="color: white;">Prompts</a> | 
            <a href="{{ url_for('notifications') }}" style="color: white;">Notifications</a> | 
            <a href="{{ url_for('logout') }}" style="color: white;">Logout</a>
        </div>
    </nav>
    <div style="padding: 20px;">
        <h1>Search PubMed</h1>
        {% if error %}
            <p style="color: red;">{{ error }}</p>
        {% endif %}
        <form id="search-form" method="POST">
            <input type="text" name="query" placeholder="Enter search query" value="{{ query or '' }}" style="width: 300px;">
            <select name="prompt_id">
                <option value="">Select a prompt</option>
                {% for prompt in prompts %}
                    <option value="{{ prompt.id }}" {% if prompt_id == prompt.id|string %}selected{% endif %}>{{ prompt.prompt_name }}</option>
                {% endfor %}
            </select>
            <textarea name="prompt_text" placeholder="Enter custom prompt" style="width: 300px; height: 100px;">{{ prompt_text or '' }}</textarea>
            <button type="submit">Search</button>
            <span id="search-spinner" class="spinner"></span>
            <span id="search-status"></span>
        </form>
        {% if result_summaries %}
            <h2>Search Results for "{{ query }}"</h2>
            {% for result, summary in result_summaries %}
                <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                    <h3>{{ result.title }}</h3>
                    <p><strong>Authors:</strong> {{ result.authors }}</p>
                    <p><strong>Journal:</strong> {{ result.journal }}</p>
                    <p><strong>Date:</strong> {{ result.publication_date }}</p>
                    <p>{{ summary.text }}...</p>
                </div>
            {% endfor %}
            {% if prompt_output %}
                <h2>Prompt Output</h2>
                <p>{{ prompt_output | replace('\n', '<br>') | safe }}</p>
            {% endif %}
        {% endif %}
    </div>
    <script>
        document.getElementById('search-form').addEventListener('submit', function() {
            const query = document.querySelector('input[name="query"]').value;
            const spinner = document.getElementById('search-spinner');
            const status = document.getElementById('search-status');
            spinner.style.display = 'inline-block';
            status.textContent = 'Starting search...';
            
            const eventSource = new EventSource(`/search_progress?query=${encodeURIComponent(query)}`);
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                status.textContent = data.status;
                if (data.status === 'complete' || data.status.startsWith('error')) {
                    spinner.style.display = 'none';
                    eventSource.close();
                }
            };
            eventSource.onerror = function() {
                status.textContent = 'Error retrieving progress';
                spinner.style.display = 'none';
                eventSource.close();
            };
        });
    </script>
</body>
</html>