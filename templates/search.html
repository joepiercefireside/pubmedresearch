<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PubMedResearcher</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .spinner {
            display: none;
            margin: 10px 0;
            width: 1.5rem;
            height: 1.5rem;
            border: 0.25em solid #007bff;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }
        .summary-generating {
            color: #007bff;
            font-style: italic;
            display: none;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="navbar">
                <a href="{{ url_for('search') }}" class="logo">PubMedResearcher</a>
                <div class="nav-links">
                    {% if username %}
                        <span>Welcome, {{ username }}</span>
                        <a href="{{ url_for('prompt') }}">Prompts</a>
                        <a href="{{ url_for('notifications') }}">Notifications</a>
                        <a href="{{ url_for('logout') }}">Logout</a>
                    {% else %}
                        <a href="{{ url_for('login') }}">Login</a>
                        <a href="{{ url_for('register') }}">Register</a>
                    {% endif %}
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section class="search-section">
            <h1>Search PubMed</h1>
            <form method="POST" action="{{ url_for('search') }}">
                <div class="form-group">
                    <label for="query">Search Query</label>
                    <input type="text" id="query" name="query" value="{{ query|default('') }}" required>
                </div>
                <div class="form-group">
                    <label for="prompt_id">Select Prompt</label>
                    <select id="prompt_id" name="prompt_id">
                        <option value="">Select a prompt...</option>
                        {% for prompt in prompts %}
                            <option value="{{ prompt.id }}" {% if prompt.id == prompt_id %}selected{% endif %}>{{ prompt.prompt_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="prompt_text">Prompt Text</label>
                    <textarea id="prompt_text" name="prompt_text">{{ prompt_text|default('') }}</textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="search_older" {% if search_older %}checked{% endif %}>
                        Search older articles (select start year)
                    </label>
                </div>
                <div class="form-group">
                    <label for="start_year">Start Year</label>
                    <select id="start_year" name="start_year">
                        {% for year in range(2000, 2026) %}
                            <option value="{{ year }}" {% if year == start_year|int(default=2000) %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit">Search</button>
            </form>
        </section>

        {% if error %}
            <div class="error">{{ error }}</div>
        {% endif %}

        <!-- AI Summary Section -->
        {% if has_prompt %}
            <section class="summary-section">
                <h3>AI Summary</h3>
                <div id="summary-loading" class="spinner"></div>
                <div id="summary-message" class="summary-generating">Generating AI response, this may take 30 to 40 seconds</div>
                <div id="summary-content"></div>
            </section>
        {% endif %}

        <!-- Search Results -->
        {% if ranked_results %}
            <section class="results-section">
                <h2>Top 10 Relevant Results (AI-Ranked)</h2>
                {% for result in ranked_results %}
                    <div class="result-card">
                        <h3>{{ result.title }}</h3>
                        <p><strong>Authors:</strong> {{ result.authors|default('N/A') }}</p>
                        <p><strong>Journal:</strong> {{ result.journal|default('N/A') }}</p>
                        <p><strong>Date:</strong> {{ result.publication_date|default('N/A') }}</p>
                        <p><strong>Abstract:</strong> {{ result.abstract|default('No abstract available')|truncate(300) }}</p>
                    </div>
                {% endfor %}
            </section>
        {% endif %}

        {% if results %}
            <section class="results-section">
                <h2>All Results</h2>
                {% for result in results %}
                    <div class="result-card">
                        <h3>{{ result.title }}</h3>
                        <p><strong>Authors:</strong> {{ result.authors|default('N/A') }}</p>
                        <p><strong>Journal:</strong> {{ result.journal|default('N/A') }}</p>
                        <p><strong>Date:</strong> {{ result.publication_date|default('N/A') }}</p>
                        <p><strong>Abstract:</strong> {{ result.abstract|default('No abstract available')|truncate(300) }}</p>
                    </div>
                {% endfor %}
            </section>
        {% endif %}

        {% if fallback_results %}
            <section class="results-section">
                <h2>Fallback Results (Outside Specified Timeframe)</h2>
                {% for result in fallback_results %}
                    <div class="result-card">
                        <h3>{{ result.title }}</h3>
                        <p><strong>Authors:</strong> {{ result.authors|default('N/A') }}</p>
                        <p><strong>Journal:</strong> {{ result.journal|default('N/A') }}</p>
                        <p><strong>Date:</strong> {{ result.publication_date|default('N/A') }}</p>
                        <p><strong>Abstract:</strong> {{ result.abstract|default('No abstract available')|truncate(300) }}</p>
                    </div>
                {% endfor %}
            </section>
        {% endif %}
    </main>

    <!-- JavaScript for Fetching AI Summary -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if ({{ has_prompt|tojson }}) {
                fetchSummary();
            }
        });

        function fetchSummary() {
            const query = '{{ query|default('')|e }}';
            const promptText = document.getElementById('prompt_text').value;
            const results = {{ results|tojson }};
            const fallbackResults = {{ fallback_results|tojson }};
            const promptParams = {{ prompt_params|tojson }};

            const formData = new FormData();
            formData.append('query', query);
            formData.append('prompt_text', promptText);
            formData.append('results', JSON.stringify(results));
            formData.append('fallback_results', JSON.stringify(fallbackResults));
            formData.append('prompt_params', JSON.stringify(promptParams));

            document.getElementById('summary-loading').style.display = 'inline-block';
            document.getElementById('summary-message').style.display = 'block';

            fetch('{{ url_for('search_summary') }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('summary-loading').style.display = 'none';
                document.getElementById('summary-message').style.display = 'none';
                const summaryContent = document.getElementById('summary-content');
                if (data.status === 'success') {
                    summaryContent.innerHTML = data.prompt_output;
                    if (data.fallback_prompt_output) {
                        summaryContent.innerHTML += '<h4>Fallback Summary</h4>' + data.fallback_prompt_output;
                    }
                } else {
                    summaryContent.innerHTML = '<p class="error-message">Error generating summary: ' + data.message + '</p>';
                }
            })
            .catch(error => {
                document.getElementById('summary-loading').style.display = 'none';
                document.getElementById('summary-message').style.display = 'none';
                document.getElementById('summary-content').innerHTML = '<p class="error-message">Failed to load summary: ' + error + '</p>';
            });
        }
    </script>
</body>
</html>