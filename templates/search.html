<!DOCTYPE html>
<html>
<head>
    <title>PubMed Researcher - Search</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}?v=1">
</head>
<body>
    {% extends "base.html" %}
    {% block content %}
    <div class="container">
        <h1>Search PubMed</h1>
        <form method="POST" action="{{ url_for('search') }}">
            <div class="form-group">
                <label for="query">Search Query:</label>
                <input type="text" id="query" name="query" value="{{ query if query else '' }}" required>
            </div>
            <div class="form-group">
                <label for="prompt_id">Select Prompt:</label>
                <select id="prompt_id" name="prompt_id">
                    <option value="">None</option>
                    {% for prompt in prompts %}
                        <option value="{{ prompt.id }}" {% if prompt.id == prompt_id %}selected{% endif %}>{{ prompt.prompt_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="prompt_text">Prompt Text (editable):</label>
                <textarea id="prompt_text" name="prompt_text" rows="4">{{ prompt_text if prompt_text else '' }}</textarea>
            </div>
            <button type="submit">Search</button>
        </form>

        {% if error %}
        <div class="error">
            <p>{{ error }}</p>
        </div>
        {% endif %}

        {% if prompt_output %}
        <div class="ai-response">
            <h2>AI Summary</h2>
            {{ prompt_output | safe }}
        </div>
        {% endif %}

        {% if results %}
        <div class="results">
            <h2>Search Results ({{ results|length }})</h2>
            {% for result in results %}
            <div class="result-card">
                <h3 class="result-title"><a href="https://pubmed.ncbi.nlm.nih.gov/{{ result.id }}/" target="_blank">{{ result.title }}</a></h3>
                <p class="result-abstract">{{ result.abstract[:300] if result.abstract else 'No abstract available.' }}...</p>
                <div class="result-meta">
                    <span><strong>Authors:</strong> {{ result.authors or 'Unknown' }}</span>
                    <span><strong>Journal:</strong> {{ result.journal or 'Unknown' }}</span>
                    <span><strong>Date:</strong> {{ result.publication_date or 'Unknown' }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const promptSelect = document.getElementById('prompt_id');
            const promptTextArea = document.getElementById('prompt_text');
            const prompts = {{ prompts | tojson }};

            promptSelect.addEventListener('change', function() {
                const selectedPromptId = this.value;
                const selectedPrompt = prompts.find(prompt => prompt.id === selectedPromptId);
                promptTextArea.value = selectedPrompt ? selectedPrompt.prompt_text : '';
            });

            const query = "{{ query | escape }}";
            if (query) {
                const source = new EventSource("/search_progress?query=" + encodeURIComponent(query));
                source.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    const statusElement = document.getElementById('search-status');
                    if (statusElement) {
                        statusElement.textContent = data.status;
                    }
                    if (data.status === "complete" || data.status.startsWith("error")) {
                        source.close();
                    }
                };
            }
        });
    </script>
    {% endblock %}
</body>
</html>