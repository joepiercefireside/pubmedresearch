{% extends "base.html" %}
{% block title %}Search{% endblock %}
{% block content %}
<div class="container">
    <h1>Search Research Articles</h1>
    <div class="card">
        <div class="card-body">
            <form method="POST" action="{{ url_for('search') }}" id="search-form">
                <div class="mb-3">
                    <label for="query" class="form-label">Search Query</label>
                    <input type="text" class="form-control" name="query" id="query" placeholder="Enter search query..." value="{{ query }}" required aria-label="Search query">
                </div>
                <div class="mb-3">
                    <label for="prompt_id" class="form-label">Select Prompt</label>
                    <select class="form-control" name="prompt_id" id="prompt_id" aria-label="Select a prompt">
                        <option value="">Select a prompt...</option>
                        {% for prompt in prompts %}
                            <option value="{{ prompt.id }}" {% if prompt_id == prompt.id %}selected{% endif %}>{{ prompt.prompt_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="prompt_text" class="form-label">Custom Prompt</label>
                    <textarea class="form-control" name="prompt_text" id="prompt_text" placeholder="Enter custom prompt..." rows="4" aria-label="Custom prompt">{{ prompt_text }}</textarea>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="search_older" id="search_older" {% if search_older %}checked{% endif %} aria-label="Search older articles">
                        <label class="form-check-label" for="search_older">Search older articles</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="start_year" class="form-label">Start Year</label>
                    <input type="number" class="form-control" name="start_year" id="start_year" placeholder="Start year" value="{{ start_year if start_year != None }}" aria-label="Start year">
                </div>
                <div class="mb-3">
                    <label class="form-label">Sources:</label>
                    <div class="form-check form-check-inline">
                        <input type="checkbox" class="form-check-input" name="sources" value="pubmed" id="source_pubmed" checked aria-label="PubMed source">
                        <label class="form-check-label" for="source_pubmed">PubMed</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="checkbox" class="form-check-input" name="sources" value="googlescholar" id="source_googlescholar" {% if 'googlescholar' in sources_selected %}checked{% endif %} aria-label="Google Scholar source">
                        <label class="form-check-label" for="source_googlescholar">Google Scholar</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="sort_by" class="form-label">Sort by</label>
                    <select class="form-control" name="sort_by" id="sort_by" aria-label="Sort by">
                        <option value="relevance" {% if sort_by == 'relevance' %}selected{% endif %}>Relevance</option>
                        <option value="date" {% if sort_by == 'date' %}selected{% endif %}>Date</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" title="Submit search" aria-label="Submit search">Search</button>
            </form>
            {% if error %}
                <div class="alert alert-danger mt-3">{{ error }}</div>
            {% endif %}
        </div>
    </div>

    <div id="search-progress" class="mt-3"></div>

    {% if sources %}
        <div class="card mt-3">
            <div class="card-body">
                {% if combined_summary %}
                    <div class="summary mt-3">
                        <h2>AI Summary</h2>
                        <p>{{ combined_summary|safe }}</p>
                    </div>
                {% endif %}
                <ul class="nav nav-tabs" id="sourceTabs" role="tablist">
                    {% for source in sources %}
                        <li class="nav-item">
                            <a class="nav-link {% if loop.first %}active{% endif %}" id="{{ source.id }}-tab" data-bs-toggle="tab" href="#{{ source.id }}-results" role="tab" aria-controls="{{ source.id }}-results" aria-selected="{% if loop.first %}true{% else %}false{% endif %}">{{ source.name }} ({{ total_results[source.id]|default(0) }})</a>
                        </li>
                    {% endfor %}
                </ul>
                <div class="tab-content" id="sourceTabsContent">
                    {% for source in sources %}
                        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ source.id }}-results" role="tabpanel" aria-labelledby="{{ source.id }}-tab">
                            {% if source.results.ranked %}
                                <h4>Top Ranked Results</h4>
                                {% for result in source.results.ranked %}
                                    <div class="result-card mb-3 p-3 border rounded">
                                        <h5><a href="{{ result.url }}" target="_blank">{{ result.title }}</a></h5>
                                        <p class="mb-1"><strong>Authors:</strong> {{ result.authors|default('N/A') }}</p>
                                        <p class="mb-1"><strong>Journal:</strong> {{ result.journal|default('N/A') }}</p>
                                        <p class="mb-1"><strong>Date:</strong> {{ result.publication_date|default('N/A') }}</p>
                                        <p>{{ result.abstract|default('No abstract available')|truncate(200) }}</p>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p>No ranked results available.</p>
                            {% endif %}
                            {% if source.results.all %}
                                <h4>All Results</h4>
                                {% for result in source.results.all %}
                                    <div class="result mb-3 p-3 border rounded">
                                        <h5><a href="{{ result.url }}" target="_blank">{{ result.title }}</a></h5>
                                        <p class="mb-1"><strong>Authors:</strong> {{ result.authors|default('N/A') }}</p>
                                        <p class="mb-1"><strong>Journal:</strong> {{ result.journal|default('N/A') }}</p>
                                        <p class="mb-1"><strong>Date:</strong> {{ result.publication_date|default('N/A') }}</p>
                                        <p>{{ result.abstract|default('No abstract available')|truncate(200) }}</p>
                                    </div>
                                {% endfor %}
                            {% endif %}
                            {% if source.results.fallback %}
                                <h4>Fallback Results</h4>
                                {% for result in source.results.fallback %}
                                    <div class="result mb-3 p-3 border rounded">
                                        <h5><a href="{{ result.url }}" target="_blank">{{ result.title }}</a></h5>
                                        <p class="mb-1"><strong>Authors:</strong> {{ result.authors|default('N/A') }}</p>
                                        <p class="mb-1"><strong>Journal:</strong> {{ result.journal|default('N/A') }}</p>
                                        <p class="mb-1"><strong>Date:</strong> {{ result.publication_date|default('N/A') }}</p>
                                        <p>{{ result.abstract|default('No abstract available')|truncate(200) }}</p>
                                    </div>
                                {% endfor %}
                            {% endif %}
                            {% if total_pages[source.id]|default(0) > 1 %}
                                <nav aria-label="Page navigation for {{ source.name }}" class="mt-3">
                                    <ul class="pagination">
                                        {% if page[source.id] > 1 %}
                                            <li class="page-item">
                                                {% if source.id == 'pubmed' %}
                                                    <a class="page-link" href="{{ url_for('search', page_pubmed=page[source.id]-1, page_googlescholar=page.get('googlescholar', 1), query=query, prompt_id=prompt_id, prompt_text=prompt_text, search_older=search_older, start_year=start_year, sort_by=sort_by, sources=sources_selected) }}" aria-label="Previous page for {{ source.name }}">Previous</a>
                                                {% elif source.id == 'googlescholar' %}
                                                    <a class="page-link" href="{{ url_for('search', page_googlescholar=page[source.id]-1, page_pubmed=page.get('pubmed', 1), query=query, prompt_id=prompt_id, prompt_text=prompt_text, search_older=search_older, start_year=start_year, sort_by=sort_by, sources=sources_selected) }}" aria-label="Previous page for {{ source.name }}">Previous</a>
                                                {% endif %}
                                            </li>
                                        {% endif %}
                                        {% for p in range(1, total_pages[source.id] + 1) %}
                                            <li class="page-item {% if p == page[source.id] %}active{% endif %}">
                                                {% if source.id == 'pubmed' %}
                                                    <a class="page-link" href="{{ url_for('search', page_pubmed=p, page_googlescholar=page.get('googlescholar', 1), query=query, prompt_id=prompt_id, prompt_text=prompt_text, search_older=search_older, start_year=start_year, sort_by=sort_by, sources=sources_selected) }}" aria-label="Page {{ p }} for {{ source.name }}">{{ p }}</a>
                                                {% elif source.id == 'googlescholar' %}
                                                    <a class="page-link" href="{{ url_for('search', page_googlescholar=p, page_pubmed=page.get('pubmed', 1), query=query, prompt_id=prompt_id, prompt_text=prompt_text, search_older=search_older, start_year=start_year, sort_by=sort_by, sources=sources_selected) }}" aria-label="Page {{ p }} for {{ source.name }}">{{ p }}</a>
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                        {% if page[source.id] < total_pages[source.id] %}
                                            <li class="page-item">
                                                {% if source.id == 'pubmed' %}
                                                    <a class="page-link" href="{{ url_for('search', page_pubmed=page[source.id]+1, page_googlescholar=page.get('googlescholar', 1), query=query, prompt_id=prompt_id, prompt_text=prompt_text, search_older=search_older, start_year=start_year, sort_by=sort_by, sources=sources_selected) }}" aria-label="Next page for {{ source.name }}">Next</a>
                                                {% elif source.id == 'googlescholar' %}
                                                    <a class="page-link" href="{{ url_for('search', page_googlescholar=page[source.id]+1, page_pubmed=page.get('pubmed', 1), query=query, prompt_id=prompt_id, prompt_text=prompt_text, search_older=search_older, start_year=start_year, sort_by=sort_by, sources=sources_selected) }}" aria-label="Next page for {{ source.name }}">Next</a>
                                                {% endif %}
                                            </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}

    <div class="chat-bubble" id="chat-bubble" title="Open chat with results" aria-label="Open chat with results">
        <i class="bi bi-chat-square-dots-fill" aria-hidden="true"></i>
        <span class="chat-bubble-text">Click Here to Chat with Results</span>
    </div>
    <div class="chat-modal" id="chat-modal">
        <div class="chat-modal-content">
            <button type="button" class="close-chat" title="Close chat" aria-label="Close chat">×</button>
            <h5 class="card-title">Chat with Research Assistant</h5>
            <div class="chat-history card-body" id="chat-history"></div>
            <form id="chat-form" class="card-footer">
                <div class="input-group">
                    <label for="chat-message" class="visually-hidden">Chat message</label>
                    <textarea class="form-control" name="message" id="chat-message" placeholder="Type your question..." required aria-label="Chat message"></textarea>
                    <button type="submit" class="btn btn-primary" title="Send message" aria-label="Send message">Send</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const prompts = {{ prompts|tojson }};

    function startProgressUpdates() {
        const query = "{{ query | e }}";
        const progressDiv = document.getElementById("search-progress");
        if (query) {
            const source = new EventSource("{{ url_for('search_progress') }}?query=" + encodeURIComponent(query));
            source.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    progressDiv.innerHTML = `<div class="alert alert-info">Status: ${data.status}</div>`;
                    console.log("Progress update:", data.status);
                    if (data.status.includes("complete")) {
                        source.close();
                    } else if (data.status.includes("error")) {
                        source.close();
                        progressDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.status}</div>`;
                    }
                } catch (e) {
                    console.error("Error parsing progress update:", e, event.data);
                    progressDiv.innerHTML = `<div class="alert alert-danger">Error parsing search progress.</div>`;
                }
            };
            source.onerror = function() {
                console.error("EventSource error for search progress");
                progressDiv.innerHTML = `<div class="alert alert-danger">Error fetching search progress.</div>`;
                source.close();
            };
        } else {
            progressDiv.innerHTML = "";
        }
    }

    $(document).ready(function() {
        const promptSelect = $('#prompt_id');
        const promptTextArea = $('#prompt_text');
        const chatBubble = $('#chat-bubble');
        const chatModal = $('#chat-modal');
        const closeChat = $('.close-chat');
        const chatForm = $('#chat-form');
        const chatHistory = $('#chat-history');
        const chatMessage = $('#chat-message');

        const tabElList = document.querySelectorAll('#sourceTabs .nav-link');
        console.log("Tabs initialized:", tabElList.length);
        tabElList.forEach(tabEl => {
            tabEl.addEventListener('click', (e) => {
                e.preventDefault();
                const tab = new bootstrap.Tab(tabEl);
                tab.show();
            });
        });

        promptSelect.change(function() {
            const selectedId = $(this).val();
            const selectedPrompt = prompts.find(p => p.id === selectedId);
            promptTextArea.val(selectedPrompt ? selectedPrompt.prompt_text : '');
        });

        chatBubble.click(function() {
            chatModal.show();
            chatForm.show();
        });

        closeChat.click(function() {
            chatModal.hide();
        });

        chatForm.submit(function(e) {
            e.preventDefault();
            const message = chatMessage.val().trim();
            if (!message) return;

            chatHistory.append(`
                <div class="message user-message mb-2 p-2 bg-light rounded">
                    <strong>You (${new Date().toLocaleString()}):</strong>
                    <p>${message}</p>
                </div>
            `);
            chatMessage.val('');
            chatHistory.scrollTop(chatHistory[0].scrollHeight);

            $.ajax({
                url: '{{ url_for("chat_message") }}',
                type: 'POST',
                data: { message: message },
                success: function(response) {
                    if (response.status === 'success') {
                        chatHistory.append(`
                            <div class="message assistant-message mb-2 p-2 bg-info-subtle rounded">
                                <strong>Assistant (${new Date().toLocaleString()}):</strong>
                                <p>${response.message.replace(/\n/g, '<br>')}</p>
                            </div>
                        `);
                        chatForm.show();
                    } else {
                        chatHistory.append(`
                            <div class="message assistant-message error mb-2 p-2 bg-danger-subtle rounded">
                                <strong>Assistant (${new Date().toLocaleString()}):</strong>
                                <p>Error: ${response.message}</p>
                            </div>
                        `);
                        chatForm.show();
                    }
                    chatHistory.scrollTop(chatHistory[0].scrollHeight);
                },
                error: function() {
                    chatHistory.append(`
                        <div class="message assistant-message error mb-2 p-2 bg-danger-subtle rounded">
                            <strong>Assistant (${new Date().toLocaleString()}):</strong>
                            <p>Error: Failed to communicate with server.</p>
                        </div>
                    `);
                    chatForm.show();
                    chatHistory.scrollTop(chatHistory[0].scrollHeight);
                }
            });
        });

        startProgressUpdates();
    });
</script>
{% endblock %}