<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PubMedResearcher</title>
</head>
<body>
    <header>
        <div>
            <h1>PubMedResearcher</h1>
            <nav>
                <ul>
                    {% if username %}
                        <li>Welcome, {{ username }}</li>
                        <li><a href="#">Prompts</a></li>
                        <li><a href="#">Notifications</a></li>
                        <li><a href="#">Logout</a></li>
                    {% else %}
                        <li><a href="#">Login</a></li>
                        <li><a href="#">Register</a></li>
                    {% endif %}
                </ul>
            </div>
        </header>

    <main>
        <section>
            <h2>Search PubMed</h2>
            <form method="POST" action="{{ url_for('search') }}">
                <div>
                    <label for="query">Search Query</label>
                    <input type="text" id="query" name="query" value="{{ query|default('') }}" required>
                </div>
                <div>
                    <label for="prompt_id">Select Prompt</label>
                    <select id="prompt_id" name="prompt_id">
                        <option value="">Select a prompt...</option>
                        {% for prompt in prompts %}
                            <option value="{{ prompt.prompt_name }}">{{ prompt.prompt_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="prompt_text">Prompt Text</label>
                    <textarea id="prompt_text" name="prompt_text">{{ prompt_text|default('') }}</textarea>
                </div>
                <div>
                    <input type="checkbox" id="older_articles" name="older_articles">
                    <label for="older_articles">Search older articles (select start year)</label>
                </div>
                <div>
                    <label for="start_year">Start Year</label>
                    <select id="start_year" name="start_year">
                        <option value="">--</option>
                        {% for year in range(2000, 2026) %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit">Search</button>
            </form>
        </section>

        {% if error %}
            <p class="error-message">{{ error }}</p>
        {% endif %}

        {% if has_prompt %}
            <section>
                <h3>AI Summary</h3>
                <div id="summary-content"></div>
                <span id="summary-loading" style="display: none;">Generating AI response, this may take 30 to 40 seconds</span>
                <span id="summary-message" style="display: none;"></span>
            </section>
        {% endif %}

        <section>
            {% if ranked_results %}
                <div>
                    <h3>Top 10 Relevant Results (AI-Ranked)</h3>
                    <ul>
                        {% for result in ranked_results %}
                            <li>
                                <h4>{{ result.title }}</h4>
                                <p>Authors: {{ result.authors|default('N/A') }}</p>
                                <p>Journal: {{ result.journal|default('N/A') }}</p>
                                <p>Date: {{ result.publication_date|default('N/A') }}</p>
                                <p>Abstract: {{ result.abstract|default('No abstract available')|truncate(300) }}</p>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if results %}
                <div>
                    <h3>All Results</h3>
                    <ul>
                        {% for result in results %}
                            <li>
                                <h4>{{ result.title }}</h4>
                                <p>Authors: {{ result.authors|default('N/A') }}</p>
                                <p>Journal: {{ result.journal|default('N/A') }}</p>
                                <p>Date: {{ result.publication_date|default('N/A') }}</p>
                                <p>Abstract: {{ result.abstract|default('No abstract available')|truncate(300) }}</p>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if fallback_results %}
                <div>
                    <h3>Fallback Results (Outside Specified Timeframe)</h3>
                    <ul>
                        {% for result in fallback_results %}
                            <li>
                                <h4>{{ result.title }}</h4>
                                <p>Authors: {{ result.authors|default('N/A') }}</p>
                                <p>Journal: {{ result.journal|default('N/A') }}</p>
                                <p>Date: {{ result.publication_date|default('N/A') }}</p>
                                <p>Abstract: {{ result.abstract|default('No abstract available')|truncate(300) }}</p>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </section>
    </main>

    <script>
        function fetchSummary() {
            console.log("fetchSummary called");
            const formData = new FormData();
            formData.append('query', '{{ query|default('')|e }}');
            formData.append('prompt_text', document.getElementById('prompt_text').value);
            formData.append('results', JSON.stringify({{ results|tojson }}));
            formData.append('fallback_results', JSON.stringify({{ fallback_results|tojson }}));
            formData.append('prompt_params', JSON.stringify({{ prompt_params|tojson|default('{}') }}));

            document.getElementById('summary-loading').style.display = 'inline-block';
            document.getElementById('summary-message').style.display = 'block';

            console.log("Before fetch");
            fetch('{{ url_for('search_summary') }}', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log("Fetch response:", response);
                return response.json();
            })
            .then(data => {
                console.log("Fetch data:", data);
                document.getElementById('summary-loading').style.display = 'none';
                document.getElementById('summary-message').style.display = 'none';
                const summaryContent = document.getElementById('summary-content');
                if (data.status === 'success') {
                    summaryContent.innerHTML = data.prompt_output;
                    if (data.fallback_prompt_output) {
                        summaryContent.innerHTML += '<h4>Fallback Summary</h4>' + data.fallback_prompt_output;
                    }
                } else {
                    summaryContent.innerHTML = '<p class="error-message">Error generating summary: ' + data.message + '</p>';
                }
            })
            .catch(error => {
                console.log("Fetch error:", error);
                document.getElementById('summary-loading').style.display = 'none';
                document.getElementById('summary-message').style.display = 'none';
                document.getElementById('summary-content').innerHTML = '<p class="error-message">Failed to load summary: ' + error + '</p>';
            });
        }

        {% if has_prompt %}
            console.log("has_prompt is true, calling fetchSummary");
            console.log("query:", '{{ query|default('')|e }}');
            console.log("prompt_text:", document.getElementById('prompt_text').value);
            console.log("results:", {{ results|tojson }});
            console.log("fallback_results:", {{ fallback_results|tojson }});
            console.log("prompt_params:", {{ prompt_params|tojson|default('{}') }});
            fetchSummary();
        {% endif %}
    </script>
</body>
</html>