{% extends "base.html" %}
{% block content %}
<div class="container">
    <h1>Search PubMed</h1>
    {% if error %}
        <p class="error">{{ error }}</p>
    {% endif %}
    {% for message in get_flashed_messages(with_categories=true) %}
        <p class="{{ message[0] }}">{{ message[1] }}</p>
    {% endfor %}
    <form id="search-form" method="POST">
        <input type="text" name="query" placeholder="Enter search query" value="{{ query or '' }}" class="input-field">
        <select name="prompt_id" class="input-field">
            <option value="">Select a prompt</option>
            {% for prompt in prompts %}
                <option value="{{ prompt.id }}" {% if prompt_id == prompt.id|string %}selected{% endif %}>{{ prompt.prompt_name }}</option>
            {% endfor %}
        </select>
        <textarea name="prompt_text" placeholder="Enter custom prompt" class="input-field textarea">{{ prompt_text or '' }}</textarea>
        <button type="submit" class="btn">Search</button>
        <span id="search-spinner" class="spinner"></span>
        <span id="search-status"></span>
    </form>
    {% if result_summaries %}
        <h2>Search Results for "{{ query }}"</h2>
        {% for result, summary in result_summaries %}
            <div class="card">
                <h3>{{ result.title }}</h3>
                <p><strong>Authors:</strong> {{ result.authors }}</p>
                <p><strong>Journal:</strong> {{ result.journal }}</p>
                <p><strong>Date:</strong> {{ result.publication_date }}</p>
                <p>{{ summary.text }}...</p>
            </div>
        {% endfor %}
        {% if prompt_output %}
            <h2>Prompt Output</h2>
            <p>{{ prompt_output | replace('\n', '<br>') | safe }}</p>
        {% endif %}
    {% endif %}
</div>
<script>
    document.getElementById('search-form').addEventListener('submit', function() {
        const query = document.querySelector('input[name="query"]').value;
        const spinner = document.getElementById('search-spinner');
        const status = document.getElementById('search-status');
        spinner.style.display = 'inline-block';
        status.textContent = 'Starting search...';
        
        const eventSource = new EventSource(`/search_progress?query=${encodeURIComponent(query)}`);
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            status.textContent = data.status;
            if (data.status === 'complete' || data.status.startsWith('error')) {
                spinner.style.display = 'none';
                eventSource.close();
            }
        };
        eventSource.onerror = function() {
            status.textContent = 'Error retrieving progress';
            spinner.style.display = 'none';
            eventSource.close();
        };
    });
</script>
{% endblock %}