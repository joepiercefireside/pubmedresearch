{% extends "base.html" %}
{% block title %}Search{% endblock %}
{% block content %}
    <div class="container">
        <h1>Search for Articles</h1>
        <form id="search-form" method="POST" action="{{ url_for('search') }}">
            <div class="form-group">
                <label>
                    <input type="checkbox" name="search_older" value="on" {{ 'checked' if search_older else '' }}>
                    Search Older Articles
                </label>
                <div class="form-group">
                    <label for="start_year">Start Year</label>
                    <select id="start_year" name="start_year" class="form-control" {{ 'disabled' if not search_older else '' }}>
                        <option value="" {{ '' if start_year else 'selected' }}>Any</option>
                        {% for year in range(current_year, 1899, -1) %}
                            <option value="{{ year }}" {{ 'selected' if start_year == year else '' }}>
                                {{ year }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="result_limit">Limit Results:</label>
                    <select id="result_limit" name="result_limit" class="form-control">
                        <option value="10" {{ 'selected' if result_limit == 10 else '' }}>10</option>
                        <option value="20" {{ 'selected' if result_limit == 20 else '' }}>20</option>
                        <option value="50" {{ 'selected' if result_limit == 50 else '' }}>50</option>
                        <option value="100" {{ 'selected' if result_limit == 100 else '' }}>100</option>
                    </select>
                </div>
            </div>
            {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
            {% endif %}
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <div class="form-group">
                <label for="query">Search Query</label>
                <input type="text" id="query" name="query" class="form-control" value="{{ query }}" required>
            </div>
            <div class="form-group">
                <label for="prompt_id">Select Prompt</label>
                <select id="prompt_id" name="prompt_id" class="form-control">
                    <option value="">No Prompt</option>
                    {% for prompt in prompts %}
                        <option value="{{ prompt.id }}" data-text="{{ prompt.prompt_text }}" {{ 'selected' if prompt_id == prompt.id else '' }}>
                            {{ prompt.prompt_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="prompt_text">Custom Prompt</label>
                <textarea id="prompt_text" name="prompt_text" class="form-control" rows="3">{{ prompt_text|default('') }}</textarea>
            </div>
            <div class="form-group">
                <label>Sources</label>
                <div>
                    <div class="form-check-inline">
                        <input type="checkbox" name="sources" value="pubmed" class="form-check-input" {{ 'checked' if 'pubmed' in sources_selected else '' }}>
                        <label class="form-check-label">PubMed</label>
                    </div>
                    <div class="form-check-inline">
                        <input type="checkbox" name="sources" value="googlescholar" class="form-check-input" {{ 'checked' if 'googlescholar' in sources_selected else '' }}>
                        <label class="form-check-label">Google Scholar</label>
                    </div>
                    <div class="form-check-inline">
                        <input type="checkbox" name="sources" value="semanticscholar" class="form-check-input" {{ 'checked' if 'semanticscholar' in sources_selected else '' }}>
                        <label class="form-check-label">Semantic Scholar</label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="sort_by">Sort By</label>
                <select id="sort_by" name="sort_by" class="form-control">
                    <option value="relevance" {{ 'selected' if sort_by == 'relevance' else '' }}>Relevance</option>
                    <option value="publication_date" {{ 'selected' if sort_by == 'publication_date' else '' }}>Publication Date</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
        <div id="search-spinner" class="spinner-border text-primary" role="status" style="display: none;">
            <span id="search-status">Starting Search...</span>
        </div>
        <a href="{{ url_for('chat') }}" class="btn btn-secondary">Chat with Results</a>
    
    {% if sources %}
        <div class="card">
            <div class="card-header">Sources</div>
            <div class="card-body">
                {% for source in sources %}
                    <h3>{{ source.name }} ({{ total_results[source.id] }})</h3>
                {% endfor %}
            </div>
        </div>
        {% for source in sources %}
            <div class="card">
                <div class="card-header">Found {{ total_results[source.id]|default(0) }} results</div>
                <div class="card-body">
                    {% if source.summary and has_prompt %}
                        <h3>{{ source.name }} Summary</h3>
                        <div class="summary-text">{{ source.summary|safe }}</div>
                    {% endif %}
                    {% if source.results.ranked %}
                        <h3>Top Ranked Results</h3>
                        {% for result in source.results.ranked %}
                            <div class="result-card">
                                <h4 class="result-title"><a href="{{ result.url }}" target="_blank">{{ result.title }}</a></h4>
                                <p class="result-abstract">{{ result.abstract|truncate(500) }}</p>
                                <p class="result-meta">Authors: {{ result.authors }} | Journal: {{ result.journal }} | Date: {{ result.publication_date }}</p>
                            </div>
                        {% endfor %}
                    {% endif %}
                    {% if source.results.all %}
                        <h3>All Results</h3>
                        {% for result in source.results.all %}
                            <div class="result-card">
                                <h4 class="result-title"><a href="{{ result.url }}" target="_blank">{{ result.title }}</a></h4>
                                <p class="result-abstract">{{ result.abstract|truncate(500) }}</p>
                                <p class="result-meta">Authors: {{ result.authors }} | Journal: {{ result.journal }} | Date: {{ result.public_date }}</p>
                            </div>
                        {% endfor %}
                    {% endif %}
                    {% if source.results.fallback %}
                        <h3>Fallback Results</h3>
                        {% for result in source.results.fallback %}
                            <div class="result-card">
                                <h4 class="result-title"><a href="{{ result.url }}" target="_blank">{{ result.title }}</a></h4>
                                <p class="result-abstract">{{ result.abstract|truncate(500) }}</p>
                                <p class="result-meta">Authors: {{ result.authors }} | Journal: {{ result.journal }} | Date: {{ result.publication_date }}</p>
                            </div>
                        {% endfor %}
                    {% endif %}
                    {% if total_results[source.id] > per_page %}
                        <nav aria-label="Page navigation">
                            <ul class="pagination">
                                {% for p in range(1, total_pages[source.id] + 1) %}
                                    {% set new_page = dict(page, **{source.id: p}) %}
                                    <li class="page-item {{ 'active' if p == page[source.id] else '' }}">
                                        <a class="page-link" href="{{ url_for('search', query=query, prompt_id=prompt_id, prompt_text=prompt_text, sources=sources_selected, search_older=search_older, start_year=start_year, sort_by=sort_by, **new_page) }}">{{ p }}</a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </nav>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% endif %}
    <script>
        $(document).ready(function() {
            $('#search-form').on('submit', function(e) {
                e.preventDefault();
                var formData = $(this).serialize();
                $('#search-spinner').show();
                $('#search-status').text('Starting Search...');

                $.ajax({
                    url: '/search',
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        $('#search-spinner').hide();
                        $('#content').html(response);
                    },
                    error: function(xhr) {
                        $('#search-spinner').hide();
                        alert('Search failed: ' + xhr.responseText);
                    }
                });

                // Poll search progress
                var query = $('#query').val();
                var es = new EventSource('/search_progress?query=' + encodeURIComponent(query));
                es.onmessage = function(event) {
                    var data = JSON.parse(event.data);
                    if (data.status.startsWith('error')) {
                        $('#search-status').text('Error: ' + data.status.split(':')[1]);
                        es.close();
                    } else if (data.status === 'complete') {
                        $('#search-status').text('Search Complete!');
                        es.close();
                        // Reload page or update results
                        location.reload();
                    } else {
                        $('#search-status').text(data.status);
                    }
                };
                es.onerror = function() {
                    $('#search-status').text('Error: Connection lost');
                    es.close();
                };
            });
        });
    </script>
{% endblock %}