{% extends "base.html" %}
{% block title %}Search{% endblock %}
{% block content %}




    
        
            
                Search for Articles

            

            
                
                    
                    Search Older Articles
                

                
                    Start Year
                    Any


                        {% for year in range(current_year, 1899, -1) %}
                            {{ year }}


                        {% endfor %}
                    
                

                
                    Limit Results:
                    10
20
50
100


                

            

        

        
            {% if error %}
                {{ error }}

            {% endif %}
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        {{ message }}

                    {% endfor %}
                {% endif %}
            {% endwith %}
            
                Search Query
                
            

            
                
                    
                        Select Prompt
                        No Prompt


                            {% for prompt in prompts %}
                                {{ prompt.prompt_name }}


                            {% endfor %}
                        
                    

                

                
                    
                        Custom Prompt
                        {{ prompt_text|default('') }}
                    

                

            

            
                Sources
                
                    
                    PubMed
                

                
                    
                    Google Scholar
                

                
                    
                    Semantic Scholar
                

            

            
                Sort By
                Relevance
Publication Date


            

            Search
        

        
            ðŸ”„ 
        

        Chat with Results
    

    {% if sources %}
        
            

                {% for source in sources %}
                    	
                        {{ source.name }} ({{ total_results[source.id] }})
                    


                {% endfor %}
            
            
                {% for source in sources %}
                    
                        Found {{ total_results[source.id]|default(0) }} results

                        {% if source.summary and has_prompt %}
                            
                                {{ source.name }} Summary

                                {{ source.summary|safe }}

                            

                        {% endif %}
                        {% if source.results.ranked %}
                            Top Ranked Results

                            {% for result in source.results.ranked %}
                                
                                    {{ result.title }}

                                    {{ result.abstract|truncate(500) }}

                                    Authors: {{ result.authors }} | Journal: {{ result.journal }} | Date: {{ result.publication_date }}

                                

                            {% endfor %}
                        {% endif %}
                        {% if source.results.all %}
                            All Results

                            {% for result in source.results.all %}
                                
                                    {{ result.title }}

                                    {{ result.abstract|truncate(500) }}

                                    Authors: {{ result.authors }} | Journal: {{ result.journal }} | Date: {{ result.publication_date }}

                                

                            {% endfor %}
                        {% endif %}
                        {% if source.results.fallback %}
                            Fallback Results

                            {% for result in source.results.fallback %}
                                
                                    {{ result.title }}

                                    {{ result.abstract|truncate(500) }}

                                    Authors: {{ result.authors }} | Journal: {{ result.journal }} | Date: {{ result.publication_date }}

                                

                            {% endfor %}
                        {% endif %}
                        {% if total_results[source.id] > per_page %}
                            
                                

                                    {% for p in range(1, total_pages[source.id] + 1) %}
                                        {% set new_page = dict(page, **{source.id: p}) %}
                                        	
                                            {{ p }}
                                        


                                    {% endfor %}
                                
                            
                        {% endif %}
                    

                {% endfor %}
            

        

    {% endif %}





{% endblock %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchForm = document.getElementById('searchForm');
        const statusText = document.getElementById('statusText');
        const spinner = document.querySelector('.spinner');
        const chatButton = document.getElementById('chatButton');
        const searchOlder = document.querySelector('input[name="search_older"]');
        const startYearGroup = document.getElementById('start_year_group');
        const startYearSelect = document.getElementById('start_year');
        let searchId = localStorage.getItem('latestSearchId') || null;

        statusText.textContent = '';

        function populatePromptText() {
            const promptSelect = document.getElementById('prompt_id');
            const promptText = document.getElementById('prompt_text');
            const selectedOption = promptSelect.options[promptSelect.selectedIndex];
            console.log('populatePromptText called, selectedOption:', selectedOption, 'prompt_id:', promptSelect.value);
            if (selectedOption && selectedOption.dataset.text) {
                promptText.value = selectedOption.dataset.text || '';
                console.log('Prompt text set to:', selectedOption.dataset.text);
            } else {
                promptText.value = '';
                console.log('No data-text or selected option, prompt_id:', promptSelect.value);
            }
        }

        function toggleStartYear() {
            const isChecked = searchOlder.checked;
            startYearGroup.style.display = isChecked ? 'inline-block' : 'none';
            startYearSelect.disabled = !isChecked;
            startYearSelect.classList.toggle('disabled-dropdown', !isChecked);
            if (isChecked) startYearSelect.focus();
        }

        if (searchId) {
            chatButton.style.display = 'block';
            chatButton.onclick = () => window.location.href = `/chat?search_id=${searchId}`;
        }

        searchForm.addEventListener('submit', (event) => {
            event.preventDefault();
            console.log('Form submitted with data:', new FormData(searchForm));
            spinner.classList.add('active');
            statusText.textContent = 'Starting search...';
            localStorage.removeItem('latestSearchId');
            chatButton.style.display = 'none';
            searchForm.submit();
        });

        searchOlder.addEventListener('change', toggleStartYear);

        const query = encodeURIComponent('{{ query or '' }}');
        const source = new EventSource(`/search_progress?query=${query}`);
        source.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.status) {
                statusText.textContent = data.status;
                console.log('Received status:', data.status);
            }
            if (data.status === 'complete' && data.search_id) {
                spinner.classList.remove('active');
                localStorage.setItem('latestSearchId', data.search_id);
                chatButton.style.display = 'block';
                chatButton.onclick = () => window.location.href = `/chat?search_id=${data.search_id}`;
            }
        };
        source.onerror = (e) => {
            console.error('EventSource error:', e);
            spinner.classList.remove('active');
            statusText.textContent = 'Error fetching search progress, retrying...';
            // Fallback polling
            setTimeout(() => {
                fetch(`/search_progress?query=${query}`)
                    .then(response => response.text())
                    .then(text => {
                        const dataMatch = text.match(/data: (\{.*\})/);
                        if (dataMatch && dataMatch[1]) {
                            const data = JSON.parse(dataMatch[1]);
                            if (data.status) statusText.textContent = data.status;
                        } else {
                            console.error('No valid data in polling response:', text);
                        }
                    })
                    .catch(err => console.error('Polling error:', err));
            }, 1000);
            source.close();
        };

        // Initialize Bootstrap tabs (already working, kept for consistency)
        $('#resultTabs a').on('click', function (e) {
            e.preventDefault();
            $(this).tab('show');
            console.log('Tab clicked:', $(this).attr('href'));
        });

        // Verify jQuery and Bootstrap
        console.log('jQuery version:', $.fn.jquery);
        if ($.fn.modal && $.fn.modal.Constructor) {
            console.log('Bootstrap version:', $.fn.modal.Constructor.VERSION);
        } else {
            console.warn('Bootstrap modal constructor not available, tab functionality may be affected');
        }

        window.addEventListener('focus', () => {
            if (localStorage.getItem('latestSearchId')) {
                chatButton.style.display = 'block';
            }
        });

        populatePromptText();
        toggleStartYear();
    });
</script>
{% endblock %}