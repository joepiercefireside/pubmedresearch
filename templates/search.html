{% extends "base.html" %}
{% block title %}Search{% endblock %}
{% block content %}
  {% set pubmed_results = pubmed_results|default([]) %}
  {% set fda_results = fda_results|default([]) %}
  {% set pubmed_fallback_results = pubmed_fallback_results|default([]) %}
  <div class="container">
    <h1>Fireside AI Search Assistant</h1>
    <form method="POST" id="search-form">
      <div class="mb-3">
        <label class="form-label">Search Sources</label>
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="source_pubmed" name="sources" value="pubmed" checked>
          <label class="form-check-label" for="source_pubmed">PubMed</label>
        </div>
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="source_fda" name="sources" value="fda">
          <label class="form-check-label" for="source_fda">FDA.gov</label>
        </div>
      </div>
      <div class="mb-3">
        <label for="query" class="form-label">Search Query</label>
        <input type="text" class="form-control" id="query" name="query" value="{{ query|default('') }}" placeholder="e.g., weight loss and diabetes">
      </div>
      <div class="mb-3">
        <label for="prompt_id" class="form-label">Select Prompt</label>
        <select class="form-select" id="prompt_id" name="prompt_id">
          <option value="">Select a prompt...</option>
          {% for prompt in prompts %}
            <option value="{{ prompt.id }}" {% if prompt.id == prompt_id %}selected{% endif %}>{{ prompt.prompt_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label for="prompt_text" class="form-label">Prompt Text</label>
        <textarea class="form-control" id="prompt_text" name="prompt_text" rows="4">{{ prompt_text|default('') }}</textarea>
      </div>
      <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" id="search_older" name="search_older" {% if search_older %}checked{% endif %}>
        <label class="form-check-label" for="search_older">Search older articles (select start year)</label>
      </div>
      <div class="mb-3" id="start_year_div" style="display: {{ 'block' if search_older else 'none' }};">
        <label for="start_year" class="form-label">Start Year</label>
        <select class="form-select" id="start_year" name="start_year">
          {% for year in range(2000, 2026) %}
            <option value="{{ year }}" {% if year == start_year|int(default=2000) %}selected{% endif %}>{{ year }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Search</button>
    </form>

    {% if error %}
      <div class="alert alert-danger mt-3">{{ error }}</div>
    {% endif %}

    <div class="results-section mt-3" id="results-section">
      {% if total_results > 0 %}
        <div class="alert alert-info">
          Found {{ total_results }} results
        </div>
      {% endif %}
      <ul class="nav nav-tabs" id="resultsTabs" role="tablist">
        {% for source in sources %}
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.first %}active{% endif %}" id="{{ source.id }}-tab" data-bs-toggle="tab" data-bs-target="#{{ source.id }}" type="button" role="tab">{{ source.name }}</button>
          </li>
        {% endfor %}
      </ul>
      <div class="tab-content" id="resultsTabsContent">
        {% for source in sources %}
          <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ source.id }}" role="tabpanel">
            {% if source.summary %}
              <div class="card mt-3">
                <div class="card-body">
                  <h3 class="card-title">AI Summary</h3>
                  <div id="{{ source.id }}-summary-loading" class="spinner" style="display: none;"></div>
                  <div id="{{ source.id }}-summary-message" class="summary-generating" style="display: none;">Generating AI response, this may take 30 to 40 seconds</div>
                  <div id="{{ source.id }}-summary-content">{{ source.summary|safe }}</div>
                </div>
              </div>
            {% endif %}
            {% if source.results.ranked %}
              <div class="card mt-3">
                <div class="card-body">
                  <h3 class="card-title">Top Relevant Results (AI-Ranked)</h3>
                  {% for result in source.results.ranked %}
                    <div class="card mb-2 shadow-sm">
                      <div class="card-body">
                        <h6 class="card-title"><a href="{{ result.url }}" target="_blank" class="text-primary">{{ result.title }}</a></h6>
                        {% if source.id == 'pubmed' %}
                          <p class="card-text small"><strong>Authors:</strong> {{ result.authors|default('N/A') }}</p>
                          <p class="card-text small"><strong>Journal:</strong> {{ result.journal|default('N/A') }}</p>
                          <p class="card-text small"><strong>Date:</strong> {{ result.publication_date|default('N/A') }}</p>
                          <p class="card-text small"><strong>Abstract:</strong> {{ result.abstract|default('No abstract available')|truncate(300) }}</p>
                        {% else %}
                          <p class="card-text small"><strong>Summary:</strong> {{ result.summary|default('No summary available')|truncate(300) }}</p>
                          <p class="card-text small"><strong>Date:</strong> {{ result.date|default('N/A') }}</p>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% if source.results.all %}
              <div class="card mt-3">
                <div class="card-body">
                  <h3 class="card-title">All Results</h3>
                  {% for result in source.results.all %}
                    <div class="card mb-2 shadow-sm">
                      <div class="card-body">
                        <h6 class="card-title"><a href="{{ result.url }}" target="_blank" class="text-primary">{{ result.title }}</a></h6>
                        {% if source.id == 'pubmed' %}
                          <p class="card-text small"><strong>Authors:</strong> {{ result.authors|default('N/A') }}</p>
                          <p class="card-text small"><strong>Journal:</strong> {{ result.journal|default('N/A') }}</p>
                          <p class="card-text small"><strong>Date:</strong> {{ result.publication_date|default('N/A') }}</p>
                          <p class="card-text small"><strong>Abstract:</strong> {{ result.abstract|default('No abstract available')|truncate(300) }}</p>
                        {% else %}
                          <p class="card-text small"><strong>Summary:</strong> {{ result.summary|default('No summary available')|truncate(300) }}</p>
                          <p class="card-text small"><strong>Date:</strong> {{ result.date|default('N/A') }}</p>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% if source.results.fallback %}
              <div class="card mt-3">
                <div class="card-body">
                  <h3 class="card-title">Fallback Results (Outside Specified Timeframe)</h3>
                  {% for result in source.results.fallback %}
                    <div class="card mb-2 shadow-sm">
                      <div class="card-body">
                        <h6 class="card-title"><a href="{{ result.url }}" target="_blank" class="text-primary">{{ result.title }}</a></h6>
                        {% if source.id == 'pubmed' %}
                          <p class="card-text small"><strong>Authors:</strong> {{ result.authors|default('N/A') }}</p>
                          <p class="card-text small"><strong>Journal:</strong> {{ result.journal|default('N/A') }}</p>
                          <p class="card-text small"><strong>Date:</strong> {{ result.publication_date|default('N/A') }}</p>
                          <p class="card-text small"><strong>Abstract:</strong> {{ result.abstract|default('No abstract available')|truncate(300) }}</p>
                        {% else %}
                          <p class="card-text small"><strong>Summary:</strong> {{ result.summary|default('No summary available')|truncate(300) }}</p>
                          <p class="card-text small"><strong>Date:</strong> {{ result.date|default('N/A') }}</p>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      {% if total_results > per_page %}
        <nav aria-label="Page navigation" class="mt-3">
          <ul class="pagination justify-content-center">
            {% if page > 1 %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('search', page=page-1, query=query, prompt_id=prompt_id, prompt_text=prompt_text, search_older=search_older, start_year=start_year, sources=sources|map(attribute='id')|list) }}">Previous</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Previous</span>
              </li>
            {% endif %}
            {% for p in range(1, total_pages + 1) %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('search', page=p, query=query, prompt_id=prompt_id, prompt_text=prompt_text, search_older=search_older, start_year=start_year, sources=sources|map(attribute='id')|list) }}">{{ p }}</a>
              </li>
            {% endfor %}
            {% if page < total_pages %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('search', page=page+1, query=query, prompt_id=prompt_id, prompt_text=prompt_text, search_older=search_older, start_year=start_year, sources=sources|map(attribute='id')|list) }}">Next</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Next</span>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const prompts = {{ prompts|tojson }};
      const promptSelect = document.getElementById('prompt_id');
      const promptTextArea = document.getElementById('prompt_text');
      const searchForm = document.getElementById('search-form');
      const resultsSection = document.getElementById('results-section');

      // Handle prompt selection
      promptSelect.addEventListener('change', function() {
        const selectedPromptId = this.value;
        const selectedPrompt = prompts.find(p => p.id === selectedPromptId);
        if (selectedPrompt) {
          promptTextArea.value = selectedPrompt.prompt_text;
        } else {
          promptTextArea.value = '';
        }
      });

      // Handle search older checkbox
      const searchOlderCheckbox = document.getElementById('search_older');
      const startYearDiv = document.getElementById('start_year_div');
      searchOlderCheckbox.addEventListener('change', function() {
        startYearDiv.style.display = this.checked ? 'block' : 'none';
      });

      // Clear results on form submission
      searchForm.addEventListener('submit', function() {
        resultsSection.innerHTML = ''; // Clear results section
        {% for source in sources %}
          const summaryContent = document.getElementById('{{ source.id }}-summary-content');
          const summaryLoading = document.getElementById('{{ source.id }}-summary-loading');
          const summaryMessage = document.getElementById('{{ source.id }}-summary-message');
          if (summaryContent) {
            summaryContent.innerHTML = '';
          }
          if (summaryLoading) {
            summaryLoading.style.display = 'inline-block';
          }
          if (summaryMessage) {
            summaryMessage.style.display = 'block';
          }
        {% endfor %}
      });

      // Fetch summaries for each source only if results exist and no initial summary
      {% if has_prompt %}
        {% for source in sources %}
          if ({{ 'true' if (source.results.ranked or source.results.all or source.results.fallback) and not source.summary else 'false' }}) {
            console.log('Fetching summary for source: {{ source.id }}');
            fetchSummary('{{ source.id }}');
          }
        {% endfor %}
      {% endif %}
    });

    function fetchSummary(sourceId) {
      console.log('Starting fetchSummary for source:', sourceId);
      const query = '{{ query|default('')|e }}';
      const promptText = document.getElementById('prompt_text').value;
      const results = sourceId === 'pubmed' ? {{ pubmed_results|tojson }} : {{ fda_results|tojson }};
      const fallbackResults = sourceId === 'pubmed' ? {{ pubmed_fallback_results|tojson }} : [];
      const promptParams = {{ prompt_params|tojson|default('{}') }};

      const formData = new FormData();
      formData.append('query', query);
      formData.append('prompt_text', promptText);
      formData.append('results', JSON.stringify(results));
      formData.append('fallback_results', JSON.stringify(fallbackResults));
      formData.append('prompt_params', JSON.stringify(promptParams));
      formData.append('source_id', sourceId);

      const summaryLoading = document.getElementById(sourceId + '-summary-loading');
      const summaryMessage = document.getElementById(sourceId + '-summary-message');
      const summaryContent = document.getElementById(sourceId + '-summary-content');

      if (summaryLoading) summaryLoading.style.display = 'inline-block';
      if (summaryMessage) summaryMessage.style.display = 'block';
      if (summaryContent) summaryContent.innerHTML = ''; // Clear previous summary

      fetch('{{ url_for('search_summary') }}', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        console.log('Fetch response status for', sourceId, ':', response.status);
        if (!response.ok) {
          throw new Error('Network response was not ok: ' + response.statusText);
        }
        return response.json();
      })
      .then(data => {
        console.log('Fetch data for', sourceId, ':', data);
        if (summaryLoading) summaryLoading.style.display = 'none';
        if (summaryMessage) summaryMessage.style.display = 'none';
        if (summaryContent) {
          if (data.status === 'success') {
            summaryContent.innerHTML = data.prompt_output;
            if (data.fallback_prompt_output && sourceId === 'pubmed') {
              summaryContent.innerHTML += '<h4>Fallback Summary</h4>' + data.fallback_prompt_output;
            }
          } else {
            console.error('Summary error for', sourceId, ':', data.message);
            summaryContent.innerHTML = '<p class="error-message">Error generating summary: ' + data.message + '</p>';
          }
        }
      })
      .catch(error => {
        console.error('Fetch error for', sourceId, ':', error);
        if (summaryLoading) summaryLoading.style.display = 'none';
        if (summaryMessage) summaryMessage.style.display = 'none';
        if (summaryContent) {
          summaryContent.innerHTML = '<p class="error-message">Failed to load summary: ' + error + '</p>';
        }
      });
    }
  </script>
{% endblock %}