{% extends "base.html" %}
{% block title %}Chat{% endblock %}
{% block content %}
<div class="container chat-container">
    <h1>Chat with AI Research Agent</h1>
    <p>Logged in as: {{ username }}</p>
    <div class="chat-layout">
        <div class="chat-sidebar">
            <div class="card retention-card">
                <div class="card-header">Search Retention Period</div>
                <div class="card-body">
                    <form method="POST">
                        <div class="form-group">
                            <input type="number" name="retention_hours" value="{{ retention_hours }}" class="form-control" min="1" max="720">
                            <small class="form-text text-muted">hours</small>
                            <button type="submit" class="btn btn-primary mt-2">Update</button>
                        </div>
                    </form>
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                </div>
                <div class="card-header">Select Searches to Chat About</div>
                <div class="card-body">
                    <form id="select-searches-form">
                        <div class="form-group">
                            {% for search in search_history %}
                                <div class="form-check">
                                    <input type="checkbox" name="selected_searches" value="{{ search.id }}" class="form-check-input" {% if search.id in search_ids %}checked{% endif %}>
                                    <label class="form-check-label">{{ search.query }} ({{ search.timestamp | datetimeformat }})</label>
                                </div>
                            {% endfor %}
                            <button type="submit" class="btn btn-primary mt-2" id="select-searches-button">Update</button>
                            <div id="select-searches-loading" style="display: none;">Updating...</div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="chat-main">
            <div class="card chat-card">
                <div class="card-header">Chat</div>
                <div class="card-body">
                    <div id="chat-error" class="alert alert-danger" style="display: none;"></div>
                    <form id="chat-form">
                        <div class="form-group">
                            <textarea name="message" class="form-control" rows="4" placeholder="Type your message..." required></textarea>
                        </div>
                        <button type="submit" id="send-button" class="btn btn-primary" disabled>Send</button>
                    </form>
                    <div id="thinking" style="display: none;">Thinking...</div>
                    <div id="chat-messages">
                        {% for msg in chat_history|reverse %}
                            <div class="chat-message {% if msg.is_user %}user-message{% else %}ai-message{% endif %}">
                                {% if msg.is_user %}
                                    <p><strong>User:</strong> {{ msg.message }}</p>
                                {% else %}
                                    <p><strong>AI:</strong> {{ msg.html_message | safe }}</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Track if search selection is complete
        var searchSelectionComplete = {{ 'true' if search_ids else 'false' }};

        // Enable/disable Send button
        function updateSendButton() {
            var selectedSearches = $('input[name="selected_searches"]:checked').map(function() {
                return $(this).val();
            }).get();
            $('#send-button').prop('disabled', selectedSearches.length === 0 || !searchSelectionComplete);
        }
        $('input[name="selected_searches"]').on('change', updateSendButton);
        updateSendButton();

        // Add target="_blank" to AI response links
        $('.ai-message a').attr('target', '_blank');

        $('#select-searches-form').on('submit', function(e) {
            e.preventDefault();
            var selectedSearches = $('input[name="selected_searches"]:checked').map(function() {
                return $(this).val();
            }).get();
            if (selectedSearches.length === 0) {
                $('#chat-error').text('Please select at least one search to chat about.').show();
                return;
            }
            $('#select-searches-button').prop('disabled', true);
            $('#select-searches-loading').show();
            $('#chat-error').hide();
            $.ajax({
                url: '{{ url_for("select_searches") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ selected_searches: selectedSearches }),
                success: function(response) {
                    if (response.status === 'success') {
                        searchSelectionComplete = true;
                        updateSendButton();
                        window.location.reload();
                    } else {
                        $('#chat-error').text(response.message).show();
                    }
                },
                error: function(xhr) {
                    $('#chat-error').text('Error selecting searches: ' + (xhr.responseJSON?.message || 'Please try again.')).show();
                },
                complete: function() {
                    $('#select-searches-button').prop('disabled', false);
                    $('#select-searches-loading').hide();
                }
            });
        });

        $('#chat-form').on('submit', function(e) {
            e.preventDefault();
            if (!searchSelectionComplete) {
                $('#chat-error').text('Please update search selection before sending a message.').show();
                return;
            }
            var message = $('textarea[name="message"]').val().trim();
            if (!message) {
                $('#chat-error').text('Message cannot be empty.').show();
                return;
            }
            $('#thinking').show();
            $('#chat-error').hide();
            $.ajax({
                url: '{{ url_for("chat_message") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ message: message }),
                success: function(response) {
                    if (response.status === 'success') {
                        $('#chat-messages').prepend(
                            '<div class="chat-message user-message"><p><strong>User:</strong> ' + message + '</p></div>' +
                            '<div class="chat-message ai-message"><p><strong>AI:</strong> ' + response.html_message + '</p></div>'
                        );
                        $('textarea[name="message"]').val('');
                        $('#thinking').hide();
                        $('.ai-message a').attr('target', '_blank');
                        $('#chat-messages').scrollTop(0);
                    } else {
                        $('#chat-error').text(response.message).show();
                        $('#thinking').hide();
                    }
                },
                error: function(xhr) {
                    $('#chat-error').text('Error sending message: ' + (xhr.responseJSON?.message || 'Please try again.')).show();
                    $('#thinking').hide();
                }
            });
        });
    });
</script>
{% endblock %}