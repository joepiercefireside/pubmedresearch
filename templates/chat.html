{% extends "base.html" %}
{% block title %}Chat{% endblock %}
{% block content %}
<link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/png">
<div class="container mt-4">
    <h2>Chat with Assistant</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <div class="card mb-4">
        <div class="card-header">Select Previous Searches</div>
        <div class="card-body">
            {% if search_history %}
                <form id="searchSelectForm">
                    {% for search in search_history %}
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="selected_searches" value="{{ search.id }}"
                                {% if search.id|string == session.get('selected_search_id', '') %}checked{% endif %}>
                            <label class="form-check-label">
                                {{ search.query }} ({{ search.timestamp|datetimeformat }})
                            </label>
                        </div>
                    {% endfor %}
                </form>
            {% else %}
                <p>No previous searches available within retention period.</p>
            {% endif %}
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-header">Chat History</div>
        <div class="card-body">
            {% if chat_history %}
                {% for message in chat_history %}
                    <div class="mb-3">
                        <strong>{{ 'You' if message.is_user else 'Assistant' }} ({{ message.timestamp|datetimeformat('%Y-%m-%d %H:%M:%S') }}):</strong>
                        <p>{{ message.message|safe }}</p>
                    </div>
                {% endfor %}
            {% else %}
                <p>No chat history available for selected searches.</p>
            {% endif %}
        </div>
    </div>
    <form method="POST" action="{{ url_for('chat') }}" id="chatForm">
        <div class="form-group">
            <label for="message">Your Message:</label>
            <textarea class="form-control" id="message" name="message" rows="4" required></textarea>
        </div>
        <div class="form-group mt-2">
            <label for="retention_hours">Chat Memory Retention (Hours):</label>
            <input type="number" class="form-control" id="retention_hours" name="retention_hours" value="{{ retention_hours }}" min="1" max="720">
        </div>
        <button type="submit" class="btn btn-primary mt-2">Send</button>
    </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchSelectForm = document.getElementById('searchSelectForm');
    if (searchSelectForm) {
        searchSelectForm.addEventListener('change', function(event) {
            const checkboxes = document.querySelectorAll('input[name="selected_searches"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            fetch('/chat/select_searches', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ session.get("csrf_token", "") }}'
                },
                body: JSON.stringify({ selected_searches: selectedIds })
            }).then(response => response.json())
              .then(data => {
                  if (data.status === 'success') {
                      console.log('Selected searches updated:', selectedIds);
                      window.location.reload();
                  } else {
                      console.error('Error updating selected searches:', data.message);
                  }
              }).catch(error => console.error('Fetch error:', error));
        });
    }
});
</script>
{% endblock %}