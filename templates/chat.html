{% extends "base.html" %}
{% block title %}Chat{% endblock %}
{% block content %}
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/png">
    <div class="container">
        <h1>Chat</h1>
        <form method="POST" action="/chat">
            <div class="form-group">
                <label for="retention_hours">Chat Memory Retention (hours)</label>
                <input type="number" class="form-control" id="retention_hours" name="retention_hours" value="{{ retention_hours }}" min="1" max="720">
                <button type="submit" class="btn btn-primary mt-2">Update Retention</button>
            </div>
        </form>
        <form method="POST" action="/chat">
            <div class="form-group">
                <label>Select Previous Searches</label>
                {% for search in search_history %}
                    <div class="form-check-inline">
                        <input type="checkbox" class="form-check-input" name="selected_searches" value="{{ search.id }}" id="search_{{ search.id }}" {% if search.id == session.get('selected_search_id') %}checked{% endif %}>
                        <label class="form-check-label" for="search_{{ search.id }}">{{ search.query }} ({{ search.timestamp|datetimeformat }})</label>
                    </div>
                {% endfor %}
            </div>
            <div class="form-group">
                <label for="message">Your Message</label>
                <textarea class="form-control" id="message" name="message" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Send</button>
        </form>
        <div id="chatHistory">
            {% for msg in chat_history|sort(attribute='timestamp', reverse=True) %}
                <div class="message {% if msg.is_user %}user-message{% else %}assistant-message{% endif %}">
                    {% if msg.is_user %}
                        {{ msg.message|e }}
                    {% else %}
                        {{ msg.html_message|safe }}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}