{% extends "base.html" %}
{% block title %}Chat{% endblock %}
{% block content %}
<link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.3.2/markdown-it.min.js" integrity="sha512-...">
<style>
    .chat-container { display: flex; flex-direction: column; height: 80vh; }
    .chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; }
    .message { margin-bottom: 10px; padding: 10px; border-radius: 5px; }
    .user-message { background-color: #e6f3ff; text-align: right; }
    .assistant-message { background-color: #f0f0f0; text-align: left; }
    .message-content { white-space: pre-wrap; }
    .input-container { padding: 10px; }
    #messageInput { resize: vertical; }
</style>
<div class="container mt-4 chat-container">
    <h2>Chat</h2>
    <div class="form-group">
        <label for="retention_hours">Chat Memory Retention (hours)</label>
        <input type="number" class="form-control" id="retention_hours" name="retention_hours" value="{{ retention_hours }}" min="1" max="720">
        <button class="btn btn-primary mt-2" onclick="updateRetention()">Update Retention</button>
    </div>
    <form id="searchSelectForm" method="POST" action="{{ url_for('select_searches') }}">
        <div class="form-group">
            <label>Select Previous Searches</label>
            {% for search in search_history %}
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" name="selected_searches" value="{{ search.id }}"
                        {% if search.id == session.get('selected_search_id') %}checked{% endif %}
                        onchange="updateSearchSelection()">
                    <label class="form-check-label">{{ search.query }} ({{ search.timestamp|datetimeformat }})</label>
                </div>
            {% endfor %}
        </div>
    </form>
    <div class="input-container">
        <form id="chatForm" method="POST">
            <div class="form-group">
                <label for="messageInput">Your Message</label>
                <textarea class="form-control" id="messageInput" name="message" rows="3" placeholder="Type your message..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary mt-2">Send</button>
        </form>
    </div>
    <div class="chat-messages" id="chatMessages">
        {% for msg in chat_history|sort(attribute='timestamp', reverse=True) %}
            <div class="message {% if msg.is_user %}user-message{% else %}assistant-message{% endif %}">
                <div class="message-content" data-markdown="{{ msg.message|e }}">{{ msg.message|e }}</div>
            </div>
        {% endfor %}
    </div>
</div>
<script>
    const md = window.markdownit();
    document.addEventListener('DOMContentLoaded', () => {
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const chatMessages = document.getElementById('chatMessages');
        const searchSelectForm = document.getElementById('searchSelectForm');

        function scrollToTop() {
            chatMessages.scrollTop = 0;
        }

        function renderMarkdown() {
            document.querySelectorAll('.message-content').forEach(el => {
                const raw = el.getAttribute('data-markdown');
                el.innerHTML = md.render(raw);
            });
        }

        renderMarkdown();
        scrollToTop();

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.submit();
            }
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            messageInput.value = '';
            const userMessage = document.createElement('div');
            userMessage.className = 'message user-message';
            userMessage.innerHTML = `<div class="message-content" data-markdown="${message}">${md.render(message)}</div>`;
            chatMessages.prepend(userMessage);
            scrollToTop();

            try {
                const response = await fetch('/chat_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ message })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    const assistantMessage = document.createElement('div');
                    assistantMessage.className = 'message assistant-message';
                    assistantMessage.innerHTML = `<div class="message-content" data-markdown="${data.message}">${md.render(data.message)}</div>`;
                    chatMessages.prepend(assistantMessage);
                    scrollToTop();
                } else {
                    alert(`Error: ${data.message}`);
                }
            } catch (error) {
                alert(`Error sending message: ${error}`);
            }
        });

        async function updateSearchSelection() {
            const selected = Array.from(document.querySelectorAll('input[name="selected_searches"]:checked')).map(input => input.value);
            if (selected.length !== 1) {
                alert('Please select exactly one search.');
                return;
            }
            try {
                const response = await fetch('/chat/select_searches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selected_searches: selected })
                });
                const data = await response.json();
                if (data.status !== 'success') {
                    alert(`Error: ${data.message}`);
                }
            } catch (error) {
                alert(`Error updating search selection: ${error}`);
            }
        }

        async function updateRetention() {
            const retentionHours = document.getElementById('retention_hours').value;
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ retention_hours: retentionHours })
                });
                if (response.ok) {
                    alert('Retention updated successfully.');
                } else {
                    alert('Error updating retention.');
                }
            } catch (error) {
                alert(`Error updating retention: ${error}`);
            }
        }
    });
</script>
{% endblock %}